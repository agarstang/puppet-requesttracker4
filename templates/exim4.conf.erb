# GENERATED BY PUPPET
# It is usually a good idea to test a new configuration for syntactic      #
# correctness before installing it (for example, by running the command    #
# "exim -C /config/file.new -bV").                                         #

trusted_users = root : Debian-exim : www-data : mail

primary_hostname = <%= @fqdn %>
local_interfaces = 127.0.0.1 : 127.0.0.2 : <%= @ipaddress %>
daemon_smtp_ports = smtp

hostlist allow_smtp_hosts = 127.0.0.1 : 127.0.0.2 : <%= @trusted_mta.join(' : ') %>

domainlist local_domains = <%= @fqdn %> : ${lookup pgsql{SELECT split_part(correspondaddress, '@', 2) FROM Queues WHERE Disabled = 0 AND correspondaddress != '' UNION SELECT split_part(commentaddress, '@', 2) FROM Queues WHERE Disabled = 0 AND commentaddress != ''}{$value}}

hide pgsql_servers="<%= @rt_dbhost %>::<%= @rt_dbport %>/<%= @rt_dbname %>/<%= @rt_dbuser %>/<%= @rt_dbpass %>"

QUERY_QUEUENAME = SELECT name FROM Queues \
            WHERE (correspondaddress = '${quote_pgsql:$local_part}@${quote_pgsql:$domain_part}' \
			or commentaddress = '${quote_pgsql:$local_part}@${quote_pgsql:$domain_part}') AND Disabled = '0'
			
QUERY_LOCALPART = SELECT split_part(correspondaddress, '@', 1) FROM Queues \
            WHERE Disabled = 0 AND split_part(correspondaddress, '@', 1) = '${quote_pgsql:$local_part}' UNION SELECT split_part(commentaddress, '@', 1) \
			FROM Queues WHERE Disabled = 0 AND split_part(commentaddress, '@', 1) = '${quote_pgsql:$local_part}'

message_size_limit = 48M
recipients_max = 1024

acl_smtp_connect = acl_check_connect
acl_smtp_rcpt = acl_check_rcpt

never_users = root

host_lookup = *
rfc1413_hosts = *
rfc1413_query_timeout = 0s

ignore_bounce_errors_after = 2d
timeout_frozen_after = 5d

delay_warning = 0s

check_spool_space = 128M
check_spool_inodes = 1000
check_log_space = 72M
check_log_inodes = 100
smtp_accept_max = 40
smtp_accept_max_per_host = 10
smtp_connect_backlog = 50

log_selector = +queue_time +queue_time_overall +smtp_confirmation

begin acl

acl_check_connect:
  # Accept SMTP from local/yin/yang only
  accept hosts = +allow_smtp_hosts

  deny  message = Email not accepted directly here.
        delay = 2s

acl_check_rcpt:
  accept  !domains = +local_domains
          hosts = +local_interfaces
  
  accept  domains = +local_domains
          hosts = +allow_smtp_hosts

  deny    message       = Restricted characters in address
          local_parts   = ^[.] : ^.*[@%!/|]
          delay = 2s
  
  deny    message = Relay access denied
          !domains = +local_domains
          !hosts = +local_interfaces
          delay = 2s

begin routers

system_aliases:
  driver = redirect
  allow_fail
  allow_defer
  domains = +local_domains
  data = ${lookup{$local_part}lsearch{/etc/aliases}}
  file_transport = address_file
  pipe_transport = address_pipe

request_tracker4:
  debug_print = "R: request_tracker4 for \
                    $local_part$local_part_suffix@$domain \
                    (calling ${substr_0:${if eq{$local_part_suffix}{-comment}{comment}{correspond} }})"
  
  driver = redirect
  domains = +local_domains
  local_parts = ${lookup pgsql{QUERY_LOCALPART}{$value}}
  local_part_suffix = -comment
  local_part_suffix_optional
  pipe_transport = request_tracker4_pipe
  data = "|/opt/rt4/bin/rt-mailgate \
           --queue \"${lookup pgsql{QUERY_QUEUENAME}}\" \
           --action ${substr_0:${if eq{$local_part_suffix}{-comment}{comment}{correspond} }} \
           --url http://localhost<%= @webpath %>"
  user = www-data

smarthost:
  driver = manualroute
  domains = *
  transport = smarthost_outbound
  route_data = "<%= @smarthost %>"


begin transports

remote_smtp:
  driver = smtp

smarthost_outbound:
  driver = smtp
  data_timeout = 15m
  hosts_require_tls = *
  hosts_require_auth = *


request_tracker4_pipe:
  debug_print = "T: request_tracker4_pipe for $local_part@$domain"
  driver = pipe
  return_fail_output
  allow_commands = /opt/rt4/bin/rt-mailgate

address_pipe:
  driver = pipe
  return_output

address_file:
  driver = appendfile
  delivery_date_add
  envelope_to_add
  return_path_add

begin retry

*                      *           F,2h,15m; G,16h,1h,1.5; F,4d,6h


begin rewrite
www-data@<%= @fqdn %> <%= @corraddr %> Fs

begin authenticators

<% if @smarthost_pass -%>
smarthost_login:
  driver = plaintext
  public_name = LOGIN
  hide client_send = : <%= @smarthost_user %> : <%= @smarthost_pass %>
  client_condition = ${if eq {$host}{<%= @smarthost %>}}
<%- end -%>
